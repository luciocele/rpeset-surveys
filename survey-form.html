<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionario RPE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
        }
        
        .badge-pre {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-post {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .info {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .slider-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .slider-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .slider-value {
            font-size: 32px;
            font-weight: bold;
            min-width: 50px;
            text-align: right;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }
        
        .slider-description {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }
        
        .visual-bar {
            display: flex;
            gap: 4px;
            margin-top: 15px;
            height: 20px;
        }
        
        .visual-bar-item {
            flex: 1;
            background: #e0e0e0;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .visual-bar-item.active {
            animation: pulse 0.3s;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .success-message {
            text-align: center;
            padding: 30px;
        }
        
        .success-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .success-text {
            font-size: 24px;
            font-weight: 600;
            color: #4caf50;
            margin-bottom: 10px;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="form-content">
            <div class="header">
                <h1 id="team-name">Questionario RPE</h1>
                <div>
                    <span class="badge" id="survey-kind-badge">POST</span>
                    <span class="badge" id="session-type-badge">Training</span>
                </div>
            </div>
            
            <div class="info">
                <div id="player-name"></div>
                <div id="survey-date"></div>
            </div>
            
            <div id="error-container"></div>
            
            <!-- RPE Slider -->
            <div class="slider-section">
                <div class="slider-header">
                    <span class="slider-title">üèÉ RPE - Intensit√†</span>
                    <span class="slider-value" id="rpe-value" style="color: #2196F3;">5</span>
                </div>
                <div class="slider-container">
                    <input type="range" id="rpe-slider" min="1" max="10" value="5" style="background: linear-gradient(90deg, #4CAF50 0%, #2196F3 50%, #FF9800 75%, #F44336 100%);">
                </div>
                <div class="slider-labels">
                    <span>1 - Molto leggero</span>
                    <span>10 - Massimo</span>
                </div>
                <div class="visual-bar" id="rpe-bar"></div>
                <div class="slider-description" id="rpe-description">Moderato</div>
            </div>
            
            <!-- Recovery Slider -->
            <div class="slider-section">
                <div class="slider-header">
                    <span class="slider-title">üí™ Recupero</span>
                    <span class="slider-value" id="recovery-value" style="color: #4CAF50;">7</span>
                </div>
                <div class="slider-container">
                    <input type="range" id="recovery-slider" min="1" max="10" value="7" style="background: linear-gradient(90deg, #F44336 0%, #FF9800 33%, #2196F3 66%, #4CAF50 100%);">
                </div>
                <div class="slider-labels">
                    <span>1 - Scarso</span>
                    <span>10 - Ottimo</span>
                </div>
                <div class="visual-bar" id="recovery-bar"></div>
                <div class="slider-description" id="recovery-description">Buon recupero</div>
            </div>
            
            <!-- Note -->
            <div class="slider-section">
                <div class="slider-title" style="margin-bottom: 15px;">üìù Note (opzionale)</div>
                <textarea id="note-field" placeholder="Aggiungi eventuali note..."></textarea>
            </div>
            
            <!-- Submit Button -->
            <button class="button" id="submit-button" onclick="submitSurvey()">
                ‚úâÔ∏è Invia Questionario
            </button>
        </div>
        
        <div id="success-content" style="display: none;">
            <div class="success-message">
                <div class="success-icon">‚úÖ</div>
                <div class="success-text">Questionario Inviato!</div>
                <p style="color: #666; margin-top: 10px;">Grazie per la compilazione</p>
            </div>
        </div>
    </div>
    
    <script>
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('s');
        const teamId = urlParams.get('t');
        const teamName = urlParams.get('tn');
        const playerId = urlParams.get('p');
        const playerName = urlParams.get('pn');
        const surveyKind = urlParams.get('k');
        const sessionType = urlParams.get('st');
        const date = urlParams.get('d');
        
        // Update UI with parameters
        if (teamName) document.getElementById('team-name').textContent = decodeURIComponent(teamName);
        if (playerName) document.getElementById('player-name').textContent = 'üë§ ' + decodeURIComponent(playerName);
        if (date) {
            const dateObj = new Date(date);
            document.getElementById('survey-date').textContent = 'üìÖ ' + dateObj.toLocaleDateString('it-IT');
        }
        
        const kindBadge = document.getElementById('survey-kind-badge');
        if (surveyKind === 'pre') {
            kindBadge.textContent = 'PRE';
            kindBadge.className = 'badge badge-pre';
        } else {
            kindBadge.textContent = 'POST';
            kindBadge.className = 'badge badge-post';
        }
        
        if (sessionType) {
            document.getElementById('session-type-badge').textContent = sessionType.charAt(0).toUpperCase() + sessionType.slice(1);
        }
        
        // RPE descriptions
        const rpeDescriptions = {
            1: 'Molto leggero', 2: 'Molto leggero',
            3: 'Leggero', 4: 'Leggero',
            5: 'Moderato', 6: 'Moderato',
            7: 'Intenso', 8: 'Intenso',
            9: 'Molto intenso', 10: 'Massimale'
        };
        
        const rpeColors = {
            1: '#4CAF50', 2: '#4CAF50',
            3: '#8BC34A', 4: '#8BC34A',
            5: '#2196F3', 6: '#2196F3',
            7: '#FF9800', 8: '#FF9800',
            9: '#F44336', 10: '#F44336'
        };
        
        // Recovery descriptions
        const recoveryDescriptions = {
            1: 'Pessimo', 2: 'Molto scarso', 3: 'Scarso',
            4: 'Sufficiente', 5: 'Sufficiente', 6: 'Discreto',
            7: 'Buono', 8: 'Buono',
            9: 'Ottimo', 10: 'Perfetto'
        };
        
        const recoveryColors = {
            1: '#F44336', 2: '#F44336', 3: '#FF5722',
            4: '#FF9800', 5: '#FF9800', 6: '#FFC107',
            7: '#8BC34A', 8: '#8BC34A',
            9: '#4CAF50', 10: '#4CAF50'
        };
        
        // Create visual bars
        function createVisualBar(containerId, count) {
            const container = document.getElementById(containerId);
            for (let i = 0; i < count; i++) {
                const item = document.createElement('div');
                item.className = 'visual-bar-item';
                item.id = `${containerId}-${i}`;
                container.appendChild(item);
            }
        }
        
        createVisualBar('rpe-bar', 10);
        createVisualBar('recovery-bar', 10);
        
        // RPE Slider
        const rpeSlider = document.getElementById('rpe-slider');
        const rpeValue = document.getElementById('rpe-value');
        const rpeDescription = document.getElementById('rpe-description');
        
        rpeSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            rpeValue.textContent = value;
            rpeValue.style.color = rpeColors[value];
            rpeDescription.textContent = rpeDescriptions[value];
            
            // Update visual bar
            for (let i = 0; i < 10; i++) {
                const item = document.getElementById(`rpe-bar-${i}`);
                if (i < value) {
                    item.style.background = rpeColors[value];
                    item.classList.add('active');
                    setTimeout(() => item.classList.remove('active'), 300);
                } else {
                    item.style.background = '#e0e0e0';
                }
            }
        });
        
        // Recovery Slider
        const recoverySlider = document.getElementById('recovery-slider');
        const recoveryValue = document.getElementById('recovery-value');
        const recoveryDescription = document.getElementById('recovery-description');
        
        recoverySlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            recoveryValue.textContent = value;
            recoveryValue.style.color = recoveryColors[value];
            recoveryDescription.textContent = recoveryDescriptions[value];
            
            // Update visual bar
            for (let i = 0; i < 10; i++) {
                const item = document.getElementById(`recovery-bar-${i}`);
                if (i < value) {
                    item.style.background = recoveryColors[value];
                    item.classList.add('active');
                    setTimeout(() => item.classList.remove('active'), 300);
                } else {
                    item.style.background = '#e0e0e0';
                }
            }
        });
        
        // Initialize bars
        rpeSlider.dispatchEvent(new Event('input'));
        recoverySlider.dispatchEvent(new Event('input'));
        
        // Submit function
        async function submitSurvey() {
            const button = document.getElementById('submit-button');
            button.disabled = true;
            button.textContent = '‚è≥ Invio in corso...';
            
            const data = {
                sessionId: sessionId,
                teamId: teamId,
                teamName: teamName,
                playerId: playerId,
                playerName: playerName,
                surveyKind: surveyKind,
                sessionType: sessionType,
                date: date,
                rpe: parseInt(rpeSlider.value),
                recoveryQuality: parseInt(recoverySlider.value),
                note: document.getElementById('note-field').value || null,
                completedAt: new Date().toISOString()
            };
            
            try {
                // CloudKit API call (implementato lato app)
                const response = await fetch('https://api.icloud.com/database/1/iCloud.com.yourapp.RPEset/production/public/records/modify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        operations: [{
                            operationType: 'create',
                            record: {
                                recordType: 'CompletedSurvey',
                                fields: Object.entries(data).map(([key, value]) => ({
                                    key: key,
                                    value: { value: value }
                                }))
                            }
                        }]
                    })
                });
                
                // Show success
                document.getElementById('form-content').style.display = 'none';
                document.getElementById('success-content').style.display = 'block';
                
                // Auto close after 3 seconds
                setTimeout(() => {
                    window.close();
                }, 3000);
                
            } catch (error) {
                button.disabled = false;
                button.textContent = '‚úâÔ∏è Invia Questionario';
                document.getElementById('error-container').innerHTML = 
                    '<div class="error-message">‚ùå Errore durante l\'invio. Riprova.</div>';
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
